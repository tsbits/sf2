var Mondrian=function(t,e,i,o,h){this.mapWidth=t||10,this.mapHeight=e||10,this.tileWidth=i||25,this.tileHeight=o||25,this.map=h||[],this.hero={x:10,y:5,speed:.2,startX:1,startY:1,invicible:!1,bag:[],hp:100,maxHp:100,respiteDuration:500},this.enemies=[],this.items=[],this.doors=[],this.gameEvents={collisions:new signals.Signal,item:new signals.Signal,itemUsed:new signals.Signal,door:new signals.Signal,heroHitted:new signals.Signal,heroDead:new signals.Signal},this.buildMap()};Mondrian.prototype.buildMap=function(t){if(0==this.map.length)for(var e=0;e<this.mapHeight;e++){for(var i=[],o=0;o<this.mapWidth;o++)t?i.push(Math.round(Math.random())):i.push(1);this.map.push(i)}this.makeBorder(),this.gameEvents.collisions.add(this.onCollision)},Mondrian.prototype.makeBorder=function(){for(var t=0;t<this.mapHeight;t++)for(var e=0;e<this.mapWidth;e++)0==t||t==this.map.length-1?this.map[t][e]=0:0!=e&&e!=this.map[t].length-1||(this.map[t][e]=0)},Mondrian.prototype.render=function(){this.moveEnemies();for(var t=0;t<this.items.length;t++){var e=this.items[t];Math.round(this.hero.x)==e.x&&Math.round(this.hero.y)==e.y&&(this.pickUpItem(t),this.gameEvents.collisions.dispatch(this,e))}for(var t=0;t<this.enemies.length;t++){var i=this.enemies[t];Math.round(this.hero.x)==Math.round(i.x)&&Math.round(this.hero.y)==Math.round(i.y)&&this.gameEvents.collisions.dispatch(this,i)}for(var t=0;t<this.doors.length;t++){var o=this.doors[t];Math.round(this.hero.x)==o.x&&Math.round(this.hero.y)==o.y&&this.gameEvents.collisions.dispatch(this,o)}},Mondrian.prototype.onCollision=function(t,e){var i=t;"door"==e.type?e.secured?e.secured&&i.hero.bag.map(function(t){return t.name}).indexOf("key")>-1&&(i.useItem(i.hero.bag.map(function(t){return t.name}).indexOf("key")),i.gameEvents.door.dispatch(e,i.hero)):i.gameEvents.door.dispatch(e,i.hero):"enemy"==e.type?i.hero.invicible||(i.hero.hp-=e.atk,i.hero.hp<=0?i.gameEvents.heroDead.dispatch(i.hero):(i.gameEvents.heroHitted.dispatch(i.hero),i.hero.invicible=!0,setTimeout(function(){i.hero.invicible=!1},i.hero.respiteDuration))):"item"==e.type&&i.gameEvents.item.dispatch(e)},Mondrian.prototype.moveHero=function(t,e,i){var o=1;"walk"==i&&(o=.25),0>t&&0!=this.map[Math.round(this.hero.y)][Math.ceil(this.hero.x)-1]&&(this.hero.x+=t*this.hero.speed*o),t>0&&0!=this.map[Math.round(this.hero.y)][Math.floor(this.hero.x)+1]&&(this.hero.x+=t*this.hero.speed*o),0>e&&0!=this.map[Math.ceil(this.hero.y)-1][Math.round(this.hero.x)]&&(this.hero.y+=e*this.hero.speed*o),e>0&&0!=this.map[Math.floor(this.hero.y)+1][Math.round(this.hero.x)]&&(this.hero.y+=e*this.hero.speed*o)},Mondrian.prototype.moveEnemies=function(){for(var t=0;t<this.enemies.length;t++){var e=this.enemies[t];if(0==e.dir&&0!=this.map[Math.round(e.y)][Math.ceil(e.x)-1])e.x-=e.speed;else if(2==e.dir&&0!=this.map[Math.round(e.y)][Math.floor(e.x)+1])e.x+=e.speed;else if(1==e.dir&&0!=this.map[Math.ceil(e.y)-1][Math.round(e.x)])e.y-=e.speed;else{if(3!=e.dir||0==this.map[Math.floor(e.y)+1][Math.round(e.x)])return void(e.dir=Math.round(3*Math.random()));e.y+=e.speed}Math.random()>.99&&(e.dir=Math.round(3*Math.random()))}},Mondrian.prototype.setHeroStart=function(t,e){this.hero.x=t,this.hero.startX=t,this.hero.y=e,this.hero.startY=e},Mondrian.prototype.setHeroSize=function(t,e){this.hero.width=t,this.hero.height=e},Mondrian.prototype.setMap=function(t){this.map=t},Mondrian.prototype.resetHeroPos=function(){this.hero.x=this.hero.startX,this.hero.y=this.hero.startY},Mondrian.prototype.addEnemy=function(t,e,i,o,h){this.enemies.push({x:t,y:e,speed:i,dir:Math.round(3*Math.random()),type:"enemy",atk:o||1,hp:h||10})},Mondrian.prototype.addItem=function(t,e,i){this.items.push({x:t,y:e,name:i,type:"item",id:this.items.length})},Mondrian.prototype.addDoor=function(t,e,i,o){this.doors.push({x:t,y:e,targetLevel:i,type:"door",secured:o||!1})},Mondrian.prototype.addWall=function(t,e,i,o){if(o)for(var h=0;i>h;h++)this.map[e+h][t]=0;else for(var h=0;i>h;h++)this.map[e][t+h]=0},Mondrian.prototype.useItem=function(t){this.hero.bag.splice(t,1)},Mondrian.prototype.pickUpItem=function(t){this.hero.bag.push(this.items.splice(t,1)[0]),this.gameEvents.itemUsed.dispatch(t)},Mondrian.prototype.isTileWalkable=function(t,e){var i=!1;return 0!=this.map[e][t]&&(i=!0),i};