var Mondrian=function(t,i,e,h,o){this.mapWidth=t||10,this.mapHeight=i||10,this.tileWidth=e||25,this.tileHeight=h||25,this.map=o||[],this.hero={x:10,y:5,speed:.2,startX:1,startY:1,invicible:!1,bag:[],hp:100,maxHp:100,respiteDuration:500},this.enemies=[],this.items=[],this.doors=[],this.gameEvents={collisions:new signals.Signal,item:new signals.Signal,door:new signals.Signal,heroHitted:new signals.Signal,heroDead:new signals.Signal},this.buildMap()};Mondrian.prototype.buildMap=function(t){if(0==this.map.length)for(var i=0;i<this.mapHeight;i++){for(var e=[],h=0;h<this.mapWidth;h++)t?e.push(Math.round(Math.random())):e.push(1);this.map.push(e)}this.makeBorder(),this.gameEvents.collisions.add(this.onCollision)},Mondrian.prototype.makeBorder=function(){for(var t=0;t<this.mapHeight;t++)for(var i=0;i<this.mapWidth;i++)0==t||t==this.map.length-1?this.map[t][i]=0:0!=i&&i!=this.map[t].length-1||(this.map[t][i]=0)},Mondrian.prototype.render=function(){this.moveEnemies();for(var t=0;t<this.items.length;t++){var i=this.items[t];Math.round(this.hero.x)==i.x&&Math.round(this.hero.y)==i.y&&(this.pickUpItem(t),this.gameEvents.collisions.dispatch(this,i))}for(var t=0;t<this.enemies.length;t++){var e=this.enemies[t];Math.round(this.hero.x)==Math.round(e.x)&&Math.round(this.hero.y)==Math.round(e.y)&&this.gameEvents.collisions.dispatch(this,e)}for(var t=0;t<this.doors.length;t++){var h=this.doors[t];Math.round(this.hero.x)==h.x&&Math.round(this.hero.y)==h.y&&this.gameEvents.collisions.dispatch(this,h)}},Mondrian.prototype.onCollision=function(t,i){var e=t;"door"==i.type?e.gameEvents.door.dispatch(i):"enemy"==i.type?e.hero.invicible||(e.hero.hp-=i.atk,e.hero.hp<=0?e.gameEvents.heroDead.dispatch(e.hero):(e.gameEvents.heroHitted.dispatch(e.hero),e.hero.invicible=!0,setTimeout(function(){e.hero.invicible=!1},e.hero.respiteDuration))):"item"==i.type&&e.gameEvents.item.dispatch(i)},Mondrian.prototype.moveHero=function(t,i,e){var h=1;"walk"==e&&(h=.25),0>t&&0!=this.map[Math.round(this.hero.y)][Math.ceil(this.hero.x)-1]&&(this.hero.x+=t*this.hero.speed*h),t>0&&0!=this.map[Math.round(this.hero.y)][Math.floor(this.hero.x)+1]&&(this.hero.x+=t*this.hero.speed*h),0>i&&0!=this.map[Math.ceil(this.hero.y)-1][Math.round(this.hero.x)]&&(this.hero.y+=i*this.hero.speed*h),i>0&&0!=this.map[Math.floor(this.hero.y)+1][Math.round(this.hero.x)]&&(this.hero.y+=i*this.hero.speed*h)},Mondrian.prototype.moveEnemies=function(){for(var t=0;t<this.enemies.length;t++){var i=this.enemies[t];if(0==i.dir&&0!=this.map[Math.round(i.y)][Math.ceil(i.x)-1])i.x-=i.speed;else if(2==i.dir&&0!=this.map[Math.round(i.y)][Math.floor(i.x)+1])i.x+=i.speed;else if(1==i.dir&&0!=this.map[Math.ceil(i.y)-1][Math.round(i.x)])i.y-=i.speed;else{if(3!=i.dir||0==this.map[Math.floor(i.y)+1][Math.round(i.x)])return void(i.dir=Math.round(3*Math.random()));i.y+=i.speed}Math.random()>.99&&(i.dir=Math.round(3*Math.random()))}},Mondrian.prototype.setHeroStart=function(t,i){this.hero.x=t,this.hero.startX=t,this.hero.y=i,this.hero.startY=i},Mondrian.prototype.setHeroSize=function(t,i){this.hero.width=t,this.hero.height=i},Mondrian.prototype.resetHeroPos=function(){this.hero.x=this.hero.startX,this.hero.y=this.hero.startY},Mondrian.prototype.addEnemy=function(t,i,e,h,o){this.enemies.push({x:t,y:i,speed:e,dir:Math.round(3*Math.random()),type:"enemy",atk:h||1,hp:o||10})},Mondrian.prototype.addItem=function(t,i,e){this.items.push({x:t,y:i,name:e,type:"item",id:this.items.length})},Mondrian.prototype.addDoor=function(t,i,e){this.doors.push({x:t,y:i,targetLevel:e,type:"door"})},Mondrian.prototype.addWall=function(t,i,e,h){if(h)for(var o=0;e>o;o++)this.map[i+o][t]=0;else for(var o=0;e>o;o++)this.map[i][t+o]=0},Mondrian.prototype.pickUpItem=function(t){this.hero.bag.push(this.items.splice(t,1)[0])},Mondrian.prototype.isTileWalkable=function(t,i){var e=!1;return 0!=this.map[i][t]&&(e=!0),e};